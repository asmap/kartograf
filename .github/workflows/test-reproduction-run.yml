name: Test Reproduction Run

on:
  push:
    branches: [master]
  pull_request:
    branches: [master]

jobs:
  test-full-run:
    runs-on: ubuntu-latest

    steps:
    - name: Install Nix
      uses: DeterminateSystems/nix-installer-action@v3

    - name: Checkout code
      uses: actions/checkout@v4

    - name: Download reproduction data hosted as release asset
      run: |
        sudo apt-get update
        sudo apt-get install -y zstd

        mkdir -p tests/data
        curl -L \
          -o tests/data/1762444800-data.tar.zst \
          "https://github.com/asmap/sample-data/releases/download/1762444800/1762444800-data.tar.zst"

        zstd -d tests/data/1762444800-data.tar.zst -c | tar -xf - -C tests/data

    - name: Run with reproduction data and check hash
      shell: bash
      run: |
        set -euo pipefail

        output=$(nix develop --command ./run map -r tests/data/1762444800 -t 1762444800 2>&1)
        echo "$output"

        echo "$output" | grep -q '8dec174852e3dad0854d41319f60dad03b017c61e822680bf9c3f8fd3ea8fc6d'
        echo "Output matches the expected value"
